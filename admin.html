<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - TrioTrack</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body, h1, h2, h3, h4, h5, h6, p, span, div, a, button, input, select {
            font-family: 'Poppins', sans-serif !important;
        }
        .page-section { display: none; animation: fadeIn 0.5s ease-in-out; padding-bottom: 80px; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Dark Mode */
        body.dark-mode { background-color: #121212 !important; color: #ffffff !important; }
        .dark-mode .card { background-color: #1e1e1e; color: #ffffff; border-color: #333; }
        .dark-mode .form-control, .dark-mode .form-select { background-color: #2d2d2d; color: #fff; border-color: #444; }
        .dark-mode .table { color: #fff; }
        .dark-mode .table-hover tbody tr:hover { background-color: #333; color: #fff; }
        .dark-mode .nav-tabs .nav-link { color: #aaa; }
        .dark-mode .nav-tabs .nav-link.active { background-color: #1e1e1e; color: #fff; border-color: #333 #333 #1e1e1e; }

        .brand-animate {
            font-size: 3rem; font-weight: bold;
            background: linear-gradient(90deg, #dc3545, #fd7e14, #ffc107);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
    </style>
</head>
<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-danger shadow fixed-top">
    <div class="container-fluid">
        <div class="text-white d-none d-md-block">
            <small id="date-display"></small> | <small id="time-display"></small>
        </div>
        <span class="navbar-brand fw-bold ms-md-3 mx-auto">üöç TrioTrack <span class="badge bg-dark small">ADMIN</span></span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-light btn-sm" onclick="setTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark')">Theme</button>
            <button id="logoutBtn" class="btn btn-dark btn-sm fw-bold d-none">Logout</button>
        </div>
    </div>
</nav>
<div style="margin-top: 80px;"></div>

<div class="container">

    <!-- PAGE 1: LOGIN -->
    <div id="page-login" class="page-section active">
        <div class="text-center mt-5">
            <h1 class="brand-animate mb-0">TRIOTRACK</h1>
            <p class="text-muted fw-bold letter-spacing-2">ADMINISTRATION</p>
        </div>
        <div class="card mx-auto shadow-lg mt-4" style="max-width: 400px; border-top: 5px solid #dc3545;">
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-user-shield fa-3x text-danger mb-2"></i>
                    <h3 class="fw-bold">Secure Login</h3>
                    <div id="system-status" class="badge bg-secondary">Connecting...</div>
                </div>
                <div class="mb-3">
                    <label class="small fw-bold">MASTER PASSWORD</label>
                    <input type="password" id="adminPass" class="form-control form-control-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button id="loginBtn" class="btn btn-danger w-100 fw-bold py-2 shadow-sm" disabled>ACCESS DASHBOARD</button>
                <p class="text-danger mt-3 text-center small fw-bold" id="loginMsg"></p>
            </div>
        </div>
    </div>

    <!-- PAGE 2: DASHBOARD -->
    <div id="page-dashboard" class="page-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold"><i class="fas fa-tachometer-alt text-danger me-2"></i>Dashboard</h2>
            <span class="badge bg-success">System Online</span>
        </div>

        <ul class="nav nav-tabs nav-justified mb-4" id="adminTabs">
            <li class="nav-item"><a class="nav-link active text-danger" id="tab-route"><i class="fas fa-route me-2"></i>Add/Edit Route</a></li>
            <li class="nav-item"><a class="nav-link text-secondary" id="tab-fleet"><i class="fas fa-bus me-2"></i>Manage Fleet</a></li>
            <li class="nav-item"><a class="nav-link text-secondary" id="tab-driver"><i class="fas fa-id-card me-2"></i>Drivers</a></li>
        </ul>

        <!-- ADD/EDIT ROUTE SECTION -->
        <div id="route-section">
            <div class="card p-4 shadow-sm border-0 border-start border-5 border-danger">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0" id="form-title">Add New Bus Route</h5>
                    <button id="cancelEditBtn" class="btn btn-sm btn-outline-secondary d-none" onclick="resetForm()">Cancel Edit</button>
                </div>
                
                <form id="routeForm">
                    <input type="hidden" id="edit-doc-id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="small text-muted">Service Category</label>
                            <select id="category" class="form-select" onchange="toggleRouteForm()">
                                <option value="Private Bus">Private Bus</option>
                                <option value="Public Bus (KSRTC)">Transport (KSRTC)</option> 
                                <option value="Interstate">Interstate</option>
                                <option value="Institution">Institution (Polytechnic)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted">Bus Number</label>
                            <input type="text" id="busNumber" class="form-control" placeholder="KL-01-AB-1234" required style="text-transform: uppercase;">
                        </div>
                    </div>

                    <!-- STANDARD FORM -->
                    <div id="standard-route-form">
                        <div class="mb-3">
                            <label class="small text-muted">Bus Name</label>
                            <input type="text" id="busName" class="form-control" placeholder="e.g. Blue Bird Exp">
                        </div>
                        <h6 class="border-bottom pb-2 mb-3 mt-4 text-primary">Route Stops & Timing</h6>
                        <div id="stops-container">
                            <div class="input-group mb-2"><span class="input-group-text bg-success text-white fw-bold" style="width: 60px;">Start</span><input type="text" id="startPoint" class="form-control" placeholder="Start Location"><input type="time" id="startTime" class="form-control" style="max-width: 130px;"></div>
                            <div class="input-group mb-2"><span class="input-group-text fw-bold" style="width: 60px;">Via</span><input type="text" class="form-control stop-loc" placeholder="Stop"><input type="time" class="form-control stop-time" style="max-width: 130px;"></div>
                            <div class="input-group mb-2"><span class="input-group-text fw-bold" style="width: 60px;">Via</span><input type="text" class="form-control stop-loc" placeholder="Stop"><input type="time" class="form-control stop-time" style="max-width: 130px;"></div>
                            <div class="input-group mb-2"><span class="input-group-text bg-danger text-white fw-bold" style="width: 60px;">End</span><input type="text" id="endPoint" class="form-control" placeholder="Destination"><input type="time" id="endTime" class="form-control" style="max-width: 130px;"></div>
                        </div>
                    </div>

                    <!-- INSTITUTION FORM -->
                    <div id="institution-route-form" class="d-none">
                        <div class="alert alert-info small py-2"><i class="fas fa-info-circle me-2"></i>Set Morning & Evening Schedules</div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="small text-muted">District</label>
                                <select id="instDistrict" class="form-select">
                                    <option value="">Select District</option>
                                    <option value="Thiruvananthapuram">Thiruvananthapuram</option>
                                    <option value="Kollam">Kollam</option>
                                    <option value="Pathanamthitta">Pathanamthitta</option>
                                    <option value="Alappuzha">Alappuzha</option>
                                    <option value="Kottayam">Kottayam</option>
                                    <option value="Idukki">Idukki</option>
                                    <option value="Ernakulam">Ernakulam</option>
                                    <option value="Thrissur">Thrissur</option>
                                    <option value="Palakkad">Palakkad</option>
                                    <option value="Malappuram">Malappuram</option>
                                    <option value="Kozhikode">Kozhikode</option>
                                    <option value="Wayanad">Wayanad</option>
                                    <option value="Kannur">Kannur</option>
                                    <option value="Kasaragod">Kasaragod</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="small text-muted">College Name</label>
                                <input type="text" id="instBusName" class="form-control" placeholder="e.g. GPTC Palakkad">
                            </div>
                        </div>
                        
                        <h6 class="text-primary mt-3 small fw-bold">MORNING (TO COLLEGE)</h6>
                        <div class="input-group mb-2"><span class="input-group-text">Start</span><input type="text" id="mornStart" class="form-control"><input type="time" id="mornStartTime" class="form-control"></div>
                        <div class="input-group mb-2"><span class="input-group-text">Via</span><input type="text" class="form-control morn-stop"><input type="time" class="form-control morn-time"></div>
                        <div class="input-group mb-2"><span class="input-group-text">Arr</span><input type="text" class="form-control" value="College Campus" disabled><input type="time" id="mornArrTime" class="form-control"></div>

                        <h6 class="text-primary mt-3 small fw-bold">EVENING (RETURN)</h6>
                        <div class="input-group mb-2"><span class="input-group-text">Dep</span><input type="text" class="form-control" value="College Campus" disabled><input type="time" id="eveDepTime" class="form-control"></div>
                        <div class="input-group mb-2"><span class="input-group-text">Via</span><input type="text" class="form-control eve-stop"><input type="time" class="form-control eve-time"></div>
                        <div class="input-group mb-2"><span class="input-group-text">End</span><input type="text" id="eveEnd" class="form-control"><input type="time" id="eveEndTime" class="form-control"></div>
                    </div>

                    <button type="submit" id="saveRouteBtn" class="btn btn-dark w-100 mt-4 fw-bold py-2"><i class="fas fa-save me-2"></i> SAVE ROUTE</button>
                </form>
            </div>
        </div>

        <!-- FLEET SECTION (VIEW/EDIT/DELETE) -->
        <div id="fleet-section" class="d-none">
            <div class="card shadow-sm border-0 border-start border-5 border-info">
                <div class="card-header bg-white border-0"><h5 class="fw-bold mb-0 pt-2">Active Fleet</h5></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light"><tr><th>Bus No.</th><th>Name</th><th>Category</th><th class="text-end">Actions</th></tr></thead>
                            <tbody id="fleet-list-body"><tr><td colspan="4" class="text-center p-3 text-muted">Loading fleet data...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- DRIVER SECTION -->
        <div id="driver-section" class="d-none">
            <div class="card p-4 shadow-sm border-0 border-start border-5 border-warning">
                <h5 class="fw-bold mb-3">Create Driver Credentials</h5>
                <form id="driverForm">
                    <div class="mb-3"><label>Bus Number</label><input type="text" id="driverBusID" class="form-control" required style="text-transform: uppercase;"></div>
                    <div class="mb-3"><label>Password</label><input type="text" id="driverPass" class="form-control" required></div>
                    <button type="submit" class="btn btn-warning w-100 fw-bold">Create Account</button>
                </form>
            </div>
        </div>
    </div>
</div>

<footer class="text-center mt-5 mb-4 text-muted small"><hr><p>¬© 2024 TrioTrack Admin</p></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, doc, getDoc, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDcWwo0m2eS1ndyC06U1G_JF1J7Y1WNlfQ", authDomain: "triotrack-66dd6.firebaseapp.com", projectId: "triotrack-66dd6", storageBucket: "triotrack-66dd6.firebasestorage.app", messagingSenderId: "994389952848", appId: "1:994389952848:web:659fbc330f2d660dfb0455", measurementId: "G-B7TMFX0F21" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allRoutesData = [];

    // --- UTILS ---
    setInterval(() => {
        const now = new Date();
        document.getElementById('date-display').innerText = now.toLocaleDateString();
        document.getElementById('time-display').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }, 1000);

    window.setTheme = (m) => document.body.classList.toggle('dark-mode', m === 'dark');
    
    // --- LOGIN ---
    const loginBtn = document.getElementById('loginBtn');
    document.getElementById('system-status').innerText = "Ready";
    document.getElementById('system-status').classList.replace('bg-secondary', 'bg-success');
    loginBtn.disabled = false;

    // Enter Key for Login
    document.getElementById('adminPass').addEventListener('keyup', (e) => { if(e.key === 'Enter') loginBtn.click(); });

    loginBtn.addEventListener('click', async () => {
        const pass = document.getElementById('adminPass').value.trim();
        if(!pass) return;
        loginBtn.disabled = true; loginBtn.innerText = "Verifying...";
        
        try {
            const snap = await getDoc(doc(db, "credentials", "admin_master"));
            if(snap.exists() && snap.data().password === pass) {
                document.getElementById('page-login').classList.remove('active');
                document.getElementById('page-dashboard').classList.add('active');
                document.getElementById('logoutBtn').classList.remove('d-none');
            } else {
                document.getElementById('loginMsg').innerText = "Incorrect Password";
                loginBtn.disabled = false; loginBtn.innerText = "ACCESS DASHBOARD";
            }
        } catch(e) { 
            console.error(e); 
            // Fallback for demo if DB not set
            if(pass === "admin123") {
                document.getElementById('page-login').classList.remove('active');
                document.getElementById('page-dashboard').classList.add('active');
                document.getElementById('logoutBtn').classList.remove('d-none');
            } else {
                document.getElementById('loginMsg').innerText = "Error / Invalid"; 
                loginBtn.disabled = false; loginBtn.innerText = "ACCESS DASHBOARD";
            }
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => location.reload());

    // --- TABS & FORM ---
    function switchTab(tId, sId) {
        ['route-section', 'fleet-section', 'driver-section'].forEach(id => document.getElementById(id).classList.add('d-none'));
        ['tab-route', 'tab-fleet', 'tab-driver'].forEach(id => {
            const el = document.getElementById(id); el.classList.remove('active', 'text-danger'); el.classList.add('text-secondary');
        });
        document.getElementById(sId).classList.remove('d-none');
        document.getElementById(tId).classList.add('active', 'text-danger');
        document.getElementById(tId).classList.remove('text-secondary');
    }
    document.getElementById('tab-route').addEventListener('click', () => switchTab('tab-route', 'route-section'));
    document.getElementById('tab-fleet').addEventListener('click', () => switchTab('tab-fleet', 'fleet-section'));
    document.getElementById('tab-driver').addEventListener('click', () => switchTab('tab-driver', 'driver-section'));

    window.toggleRouteForm = () => {
        const cat = document.getElementById('category').value;
        document.getElementById('standard-route-form').classList.toggle('d-none', cat === 'Institution');
        document.getElementById('institution-route-form').classList.toggle('d-none', cat !== 'Institution');
    };

    window.resetForm = () => {
        document.getElementById('routeForm').reset();
        document.getElementById('form-title').innerText = "Add New Bus Route";
        document.getElementById('saveRouteBtn').innerHTML = "<i class='fas fa-save me-2'></i> SAVE ROUTE";
        document.getElementById('edit-doc-id').value = "";
        document.getElementById('cancelEditBtn').classList.add('d-none');
        toggleRouteForm();
    };

    // --- CRUD ---
    // 1. SAVE / UPDATE
    document.getElementById('routeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-doc-id').value;
        const cat = document.getElementById('category').value;
        let data = {
            busNumber: document.getElementById('busNumber').value.toUpperCase(),
            category: cat,
            busName: cat === 'Institution' ? document.getElementById('instBusName').value : document.getElementById('busName').value,
            searchKeywords: []
        };

        if(cat === 'Institution') {
            data.district = document.getElementById('instDistrict').value;
            // Morning
            data.morningRoute = [{name: document.getElementById('mornStart').value, time: document.getElementById('mornStartTime').value}];
            document.querySelectorAll('.morn-stop').forEach((el, i) => {
                if(el.value) data.morningRoute.push({name: el.value, time: document.querySelectorAll('.morn-time')[i].value});
            });
            data.morningRoute.push({name: data.busName, time: document.getElementById('mornArrTime').value});
            // Evening
            data.eveningRoute = [{name: data.busName, time: document.getElementById('eveDepTime').value}];
            document.querySelectorAll('.eve-stop').forEach((el, i) => {
                if(el.value) data.eveningRoute.push({name: el.value, time: document.querySelectorAll('.eve-time')[i].value});
            });
            data.eveningRoute.push({name: document.getElementById('eveEnd').value, time: document.getElementById('eveEndTime').value});
            data.searchKeywords = [data.district.toLowerCase(), data.busName.toLowerCase()];
        } else {
            let stops = [{name: document.getElementById('startPoint').value, time: document.getElementById('startTime').value}];
            document.querySelectorAll('#stops-container .stop-loc').forEach((el, i) => {
                if(el.value) stops.push({name: el.value, time: document.querySelectorAll('#stops-container .stop-time')[i].value});
            });
            stops.push({name: document.getElementById('endPoint').value, time: document.getElementById('endTime').value});
            data.route = stops;
            data.searchKeywords = stops.map(s => s.name.toLowerCase().trim());
        }

        try {
            if(id) { await updateDoc(doc(db, "routes", id), data); alert("Route Updated!"); }
            else { await addDoc(collection(db, "routes"), data); alert("Route Saved!"); }
            resetForm();
        } catch(err) { alert(err.message); }
    });

    // 2. READ (Realtime Fleet)
    onSnapshot(collection(db, "routes"), (snap) => {
        allRoutesData = [];
        const tbody = document.getElementById('fleet-list-body');
        if(snap.empty) { tbody.innerHTML = '<tr><td colspan="4" class="text-center p-3">No routes found.</td></tr>'; return; }
        
        let html = "";
        snap.forEach(d => {
            const bus = d.data();
            bus.id = d.id;
            allRoutesData.push(bus);
            html += `<tr>
                <td class="fw-bold">${bus.busNumber}</td>
                <td>${bus.busName}</td>
                <td><span class="badge bg-secondary">${bus.category}</span></td>
                <td class="text-end">
                    <button class="btn btn-sm btn-primary me-1" onclick="window.editRoute('${bus.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="window.deleteRoute('${bus.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    });

    // 3. EDIT
    window.editRoute = (id) => {
        const bus = allRoutesData.find(b => b.id === id);
        if(!bus) return;
        switchTab('tab-route', 'route-section');
        document.getElementById('form-title').innerText = "Edit Bus Route";
        document.getElementById('saveRouteBtn').innerHTML = "<i class='fas fa-sync me-2'></i> UPDATE ROUTE";
        document.getElementById('cancelEditBtn').classList.remove('d-none');
        document.getElementById('edit-doc-id').value = id;
        document.getElementById('busNumber').value = bus.busNumber;
        document.getElementById('category').value = bus.category;
        toggleRouteForm();

        if(bus.category === 'Institution') {
            document.getElementById('instDistrict').value = bus.district;
            document.getElementById('instBusName').value = bus.busName;
            if(bus.morningRoute && bus.morningRoute.length > 0) {
                document.getElementById('mornStart').value = bus.morningRoute[0].name;
                document.getElementById('mornStartTime').value = bus.morningRoute[0].time;
            }
        } else {
            document.getElementById('busName').value = bus.busName;
            if(bus.route && bus.route.length > 0) {
                document.getElementById('startPoint').value = bus.route[0].name;
                document.getElementById('startTime').value = bus.route[0].time;
                document.getElementById('endPoint').value = bus.route[bus.route.length-1].name;
                document.getElementById('endTime').value = bus.route[bus.route.length-1].time;
            }
        }
    };

    // 4. DELETE
    window.deleteRoute = async (id) => { if(confirm("Delete this route?")) await deleteDoc(doc(db, "routes", id)); };

    // 5. DRIVER
    document.getElementById('driverForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('driverBusID').value.toUpperCase();
        const pass = document.getElementById('driverPass').value;
        try { await setDoc(doc(db, "credentials", id), { password: pass }); alert("Driver Created!"); e.target.reset(); } catch(e){alert(e.message);}
    });

</script>
</body>
</html>
